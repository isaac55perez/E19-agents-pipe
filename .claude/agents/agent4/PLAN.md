# Agent4: Gmail Draft Creator

## Overview

Agent4 reads the final processed data from Agent3 (`output/output34.xlsx`) and creates Gmail draft emails for each entry. Each draft contains the personalized greeting message and the repository URL, ready for manual review and sending.

## Purpose

Transform the graded submissions with personalized greetings into Gmail draft emails, allowing users to review and send motivational messages to students with their code quality feedback.

## Input/Output

### Input File
- **Path**: `output/output34.xlsx` (relative to project root)
- **Source**: Generated by Agent3 (Excel Greeting Transformer)
- **Required Columns**:
  - `email`: Student email address (to send draft to)
  - `name`: Student name (for personalization)
  - `Repo URL`: GitHub repository URL
  - `grade`: Code quality grade (0-100)
  - `greeting`: Personalized greeting message (Eddie Murphy or Donald Trump style)

### Output
- **Type**: Gmail drafts created via Gmail API
- **Location**: Gmail drafts folder in authenticated user's account
- **Content**: HTML-formatted emails with greeting, repository link, and student details
- **Status**: Unfinished drafts (not sent automatically)

## Data Flow

```
Input (output34.xlsx)
    ↓
Read Excel File
    ↓
Authenticate Gmail API
    ↓
For Each Entry:
  - Compose email with greeting + repo URL
  - Create Gmail draft
  - Log result
    ↓
Summary Report
    ↓
Success ✓
```

## Core Responsibilities

### 1. Excel File Reading
- Read `output/output34.xlsx` using openpyxl
- Parse all required columns
- Validate email addresses and data
- Handle missing or invalid entries gracefully

### 2. Gmail API Integration
- Authenticate using OAuth2 (Google authentication)
- Create draft emails (not send)
- Use Gmail API with proper error handling
- Manage API quotas and rate limits

### 3. Email Composition
- Create HTML-formatted email body
- Include greeting message
- Add clickable repository URL
- Include student name and grade information
- Format professionally and clearly

### 4. Draft Creation
- Create email draft for each valid entry
- Draft sent to student's email address
- Subject line: "Your Code Review - [Repository Name]" or similar
- Store draft in Gmail drafts folder

### 5. Logging and Error Handling
- Log successful draft creation
- Handle Gmail API errors gracefully
- Report invalid email addresses
- Continue processing despite individual failures
- Summary of successes and failures

## Technical Guidelines

### Path Handling
- Use relative paths exclusively
- All file operations relative to project root
- Use `pathlib.Path` for cross-platform compatibility

### Gmail API Authentication
- Use OAuth2 for user authentication
- Store credentials securely (follow Google best practices)
- Request minimal required scopes (compose drafts only)
- Handle token refresh automatically

### Email Format
- Use HTML template for professional appearance
- Include:
  - Greeting message prominently
  - Student name and repository URL
  - Grade information (optional)
  - Professional footer
- Plain text fallback for clients that don't support HTML

### Dependencies
- **google-auth**: OAuth2 authentication
- **google-api-python-client**: Gmail API client
- **openpyxl**: Excel file reading
- **python-dotenv** (optional): Credentials management

### Error Handling
- Invalid email addresses: Log and skip, continue processing
- Gmail API failures: Retry with exponential backoff
- Missing credentials: Clear error message with setup instructions
- Network errors: Timeout handling with retry logic
- Rate limiting: Implement delay between API calls

### Logging
- Log authentication success/failure
- Log each draft creation attempt
- Log API errors with details
- Summary statistics at completion
- Verbose mode for debugging

## Implementation Structure

### Module: `gmail_client.py`
**Purpose**: Gmail API integration

**Classes**:
- `GmailAuthenticator`: Handle OAuth2 authentication
  - `authenticate()`: Establish Gmail API connection
  - `is_authenticated()`: Check authentication status

- `GmailDraftCreator`: Create draft emails
  - `create_draft(to_email, subject, body_html, body_text)`: Create single draft
  - `create_drafts_batch(emails_list)`: Create multiple drafts

### Module: `email_composer.py`
**Purpose**: Compose email content

**Classes**:
- `EmailComposer`: Generate email content
  - `compose_email(entry)`: Create email from entry
  - `generate_subject(name, repo_url)`: Create subject line
  - `generate_html_body(entry)`: Generate HTML email body
  - `generate_text_body(entry)`: Generate plain text body

### Module: `excel_reader.py`
**Purpose**: Read and validate input data

**Classes**:
- `ExcelReader`: Read Excel file
  - `read_input_file(file_path)`: Read and parse Excel
  - `validate_entries(rows_data)`: Validate email addresses and data
  - `extract_urls(entries)`: Validate repository URLs

### Module: `main.py`
**Purpose**: Orchestrate workflow

**Functions**:
- `main()`: Main entry point
- `parse_arguments()`: CLI argument parsing
- `run_workflow()`: Coordinate entire process

## Email Content Template

### Subject Line
```
Your Code Review - [Repository Name]
```
Or simply:
```
Code Submission Feedback
```

### HTML Email Body Structure
```
Dear [Student Name],

[GREETING MESSAGE - prominently displayed]

Your code submission for repository [Repository Name] has been reviewed.

Repository: [Clickable Link to Repo URL]
Grade: [X.XX]%

We appreciate your work and feedback on areas for improvement.

Best regards,
Instructor
```

### Example Email
**To**: student@example.com
**Subject**: Code Submission Feedback
**Body**:
```
Dear Alice,

Fantastic work! You're a winner, and these grades prove it. Tremendous execution!

Your code submission for repository E18_logistic_regression has been reviewed.

Repository: https://github.com/isaac55perez/E18_logistic_regression.git
Grade: 80.00%

We appreciate your work and feedback on areas for improvement.

Best regards,
Instructor
```

## Configuration

### OAuth2 Setup
- **Scopes Required**: `https://www.googleapis.com/auth/gmail.compose`
- **Redirect URI**: `http://localhost:8080` (for local development)
- **Credentials File**: `credentials.json` in agent4 directory
- **Token File**: `token.json` (auto-created after first auth)

### File Paths
- **Input**: `output/output34.xlsx` (relative to project root)
- **Credentials**: `.claude/agents/agent4/credentials.json`
- **Token Cache**: `.claude/agents/agent4/token.json`

### Rate Limiting
- Default: 1 second delay between API calls
- Configurable via `--delay` parameter
- Respect Gmail API quotas (1000 requests per user per day)

## Usage

### Command Line
```bash
# Default usage (creates drafts for all entries)
python main.py

# With custom delay between emails
python main.py --delay 2

# Verbose logging
python main.py --verbose

# Dry run (shows what would be created without API calls)
python main.py --dry-run

# Specific number of entries
python main.py --limit 10
```

### First Time Setup
```bash
# 1. Set up Google Cloud Project and obtain credentials.json
# 2. Place credentials.json in agent4 directory
# 3. Run the agent (will prompt for authentication)
python main.py

# 4. Complete OAuth2 flow in browser
# 5. Token saved automatically for future use
```

## Error Handling

### Common Issues and Solutions

| Issue | Cause | Solution |
|-------|-------|----------|
| Input file not found | Agent3 hasn't run | Run Agent3 first to generate output34.xlsx |
| Invalid email address | Malformed email in entry | Log error, skip entry, continue |
| Gmail API error (401) | Token expired or invalid | Re-authenticate with OAuth2 |
| Gmail API error (403) | Insufficient permissions | Check OAuth2 scopes |
| Gmail API error (429) | Rate limited | Implement exponential backoff |
| Network error | Connection timeout | Retry with configurable retry logic |
| Missing credentials.json | OAuth2 setup incomplete | Follow setup instructions in README |

### Error Messages
- `FileNotFoundError`: Input file missing - run Agent3 first
- `ValueError`: Invalid email address format
- `AuthenticationError`: Gmail authentication failed
- `APIError`: Gmail API returned error [code]
- `ConnectionError`: Network timeout, retrying...

## Testing Strategy

### Unit Tests
- Email validation functions
- Email composition (HTML/text generation)
- Excel reading and parsing
- Error handling for invalid data

### Integration Tests
- End-to-end workflow with mock Gmail API
- Successful draft creation
- Error handling and recovery
- Multiple entry processing

### Mock Testing
- Use unittest.mock for Gmail API
- Mock successful and failed API calls
- Test retry logic
- Verify draft content

## Logging and Reporting

### Log Levels
- **INFO**: High-level progress (authentication, draft creation)
- **DEBUG**: Detailed operations (API calls, email composition)
- **WARNING**: Non-critical issues (invalid emails, skipped entries)
- **ERROR**: Processing failures (API errors, auth failures)

### Log Output Example
```
2024-01-15 10:30:00 - agent4 - INFO - ============================================================
2024-01-15 10:30:00 - agent4 - INFO - Gmail Draft Creator
2024-01-15 10:30:00 - agent4 - INFO - ============================================================
2024-01-15 10:30:00 - agent4 - INFO - Reading input file: output/output34.xlsx
2024-01-15 10:30:00 - excel_reader - INFO - Found 4 entries
2024-01-15 10:30:00 - agent4 - INFO - Authenticating with Gmail API...
2024-01-15 10:30:00 - gmail_client - INFO - Successfully authenticated with Gmail
2024-01-15 10:30:00 - agent4 - INFO - Creating Gmail drafts...
2024-01-15 10:30:00 - gmail_client - DEBUG - Creating draft for student@example.com
2024-01-15 10:30:00 - gmail_client - INFO - Draft created: alice@example.com
2024-01-15 10:30:00 - gmail_client - DEBUG - Creating draft for bob@example.com
2024-01-15 10:30:00 - gmail_client - INFO - Draft created: bob@example.com
2024-01-15 10:30:00 - agent4 - INFO - ============================================================
2024-01-15 10:30:00 - agent4 - INFO - Completion Summary
2024-01-15 10:30:00 - agent4 - INFO - ============================================================
2024-01-15 10:30:00 - agent4 - INFO - Total entries: 4
2024-01-15 10:30:00 - agent4 - INFO - Successful drafts: 4
2024-01-15 10:30:00 - agent4 - INFO - Failed: 0
2024-01-15 10:30:00 - agent4 - INFO - Success rate: 100.0%
```

## Quality Assurance

After running Agent4, verify:

- [ ] All entries processed
- [ ] Drafts visible in Gmail drafts folder
- [ ] Email addresses correct
- [ ] Greeting messages included
- [ ] Repository URLs clickable and correct
- [ ] HTML formatting renders properly
- [ ] No duplicate drafts created
- [ ] Error log shows no critical issues

## Security Considerations

### OAuth2 Security
- Never commit `credentials.json` or `token.json`
- Use `.gitignore` to exclude credential files
- Request minimal required scopes
- Token stored locally only, not transmitted

### Email Security
- Verify email addresses before sending
- Do not store email content in logs (except for testing)
- Use HTTPS for any web components
- Follow Gmail API security best practices

### Data Handling
- Excel file contains PII (student emails, names)
- Handle carefully and securely
- Clean up temporary files
- Log only necessary information

## Edge Cases

### Handling Edge Cases

1. **Duplicate Emails**: If multiple entries have same email
   - Create separate drafts for each entry
   - Log as warning
   - Continue processing

2. **Empty Greeting**: If greeting is missing or empty
   - Generate default message
   - Log as warning
   - Continue processing

3. **Invalid Repo URLs**: If repository URL is malformed
   - Still include in draft for manual review
   - Log as warning
   - Continue processing

4. **Very Large Batch**: If 1000+ entries
   - Respect Gmail API quotas
   - Implement batch delay
   - Show progress indicator
   - Consider split into multiple runs

5. **Existing Drafts**: If draft already exists
   - Create new draft (Gmail allows duplicates)
   - Or check for existing and skip (configurable)

## Performance

- **Time Complexity**: O(n) where n = number of entries
- **API Calls**: n calls to Gmail API (one per entry)
- **Typical Speed**: 1-2 seconds per draft (including API delay)
- **Batch Processing**: 4 entries = 4-8 seconds

### Example Timing
- 4 entries: ~6-8 seconds
- 10 entries: ~15-20 seconds
- 50 entries: ~1.5-2.5 minutes
- 100 entries: ~3-5 minutes (consider batch delays)

## Integration with Pipeline

Agent4 completes the exercise submission pipeline:

1. **Agent1**: Extract Gmail exercises → `output12.xlsx`
2. **Agent2**: Analyze repositories → `output23.xlsx`
3. **Agent3**: Add greetings → `output34.xlsx`
4. **Agent4**: Create Gmail drafts → Gmail drafts folder ✓

## Future Enhancements

- [ ] Send emails directly instead of creating drafts
- [ ] Custom email templates per personality style
- [ ] Attachment support (e.g., grade report PDF)
- [ ] Scheduling: Send emails at specific time
- [ ] Reply templates for common questions
- [ ] Tracking: Monitor which students opened emails
- [ ] Analytics: Generate statistics about submissions
- [ ] Batch mode: Process multiple input files
- [ ] Webhook integration with external systems
- [ ] SMS notification fallback

## Project Compliance

### CLAUDE.md Standards
- ✓ Relative paths (no absolute paths)
- ✓ Logging at all major operations
- ✓ Type hints throughout
- ✓ Error handling with try-except
- ✓ Comprehensive documentation
- ✓ Tests covering edge cases
- ✓ Proper package structure with `__init__.py`

### Dependencies
- **openpyxl**: >=3.0.0 (Excel reading)
- **google-auth**: >=2.0.0 (OAuth2 authentication)
- **google-auth-oauthlib**: >=0.4.0 (OAuth2 flow)
- **google-auth-httplib2**: >=0.1.0 (HTTP transport)
- **google-api-python-client**: >=2.0.0 (Gmail API)
- **python-dotenv**: >=0.19.0 (optional, credentials management)

## Dependencies Installation

```bash
# Using uv (recommended)
uv pip install -e .

# Or using pip
pip install -e .
```

## Support and Debugging

### Setup Issues
1. Check Google Cloud Project configuration
2. Verify OAuth2 credentials obtained correctly
3. Ensure credentials.json in correct location
4. Check file permissions on token files

### API Issues
1. Verify Gmail API is enabled in Google Cloud Console
2. Check OAuth2 scopes are correct
3. Verify account has draft creation permissions
4. Check API quota limits

### Data Issues
1. Verify output34.xlsx exists and has correct format
2. Check email addresses are valid format
3. Verify repository URLs are accessible
4. Check for special characters in names

### Debugging
Enable verbose logging:
```bash
python main.py --verbose
```

Check Gmail API documentation:
https://developers.google.com/gmail/api/guides

## Success Criteria

Agent4 is successfully implemented when:
- ✓ Reads all entries from output34.xlsx
- ✓ Authenticates with Gmail API
- ✓ Creates draft for each valid entry
- ✓ Drafts contain greeting and repo URL
- ✓ 100+ unit tests passing
- ✓ Handles errors gracefully
- ✓ Logs all operations
- ✓ Follows project standards

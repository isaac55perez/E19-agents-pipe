# Agent4: Gmail Draft Creator

Create Gmail draft emails from processed exercise submissions with personalized greetings and repository URLs.

## Overview

Agent4 reads processed student submission data from `output/output34.xlsx` (generated by Agent3) and creates Gmail draft emails for each entry. Each draft contains:

- **Personalized Greeting**: Eddie Murphy or Donald Trump style greetings (based on grade)
- **Repository Information**: Clickable link to student's GitHub repository
- **Grade Information**: Code quality grade percentage
- **Professional Formatting**: HTML and plain text email versions

The drafts are created in your Gmail account and ready for manual review before sending.

## Features

- **Email Validation**: Validates email addresses before processing
- **URL Validation**: Checks repository URLs for proper GitHub format
- **HTML & Text Formats**: Creates both HTML-formatted and plain text email versions
- **Error Handling**: Gracefully handles invalid entries and continues processing
- **Dry-Run Mode**: Preview what would be created without calling Gmail API
- **Progress Tracking**: Detailed logging of all operations
- **Batch Processing**: Create multiple drafts efficiently
- **Statistics**: Summary report of successful and failed operations

## Installation

### Prerequisites

- Python 3.8 or higher
- `uv` package manager

### Setup

1. Clone/navigate to the agent4 directory:
```bash
cd .claude/agents/agent4
```

2. Install dependencies:
```bash
# Using uv (recommended)
uv pip install -e .

# Or using pip
pip install -e .
```

3. (Optional) Install development dependencies:
```bash
uv pip install -e ".[dev]"
```

## Gmail API Setup

### First-Time Authentication

To use Agent4, you need to set up Google Cloud credentials:

1. **Create a Google Cloud Project**:
   - Visit [Google Cloud Console](https://console.cloud.google.com)
   - Create a new project (e.g., "Exercise Submission Agent")

2. **Enable Gmail API**:
   - In the Cloud Console, enable the Gmail API
   - Create OAuth 2.0 credentials:
     - Application type: Desktop application
     - Download credentials as `credentials.json`

3. **Place credentials.json**:
   - Save the credentials file as `.claude/agents/agent4/credentials.json`
   - **Important**: Add `credentials.json` to `.gitignore` to avoid committing secrets

4. **First Run**:
   ```bash
   python main.py --dry-run
   ```
   - This will guide you through OAuth2 authentication
   - A browser window will open for you to grant permissions
   - Token is saved locally in `token.json` for future use

### Security Notes

- **Never commit** `credentials.json` or `token.json`
- Credentials are stored locally only
- Add to `.gitignore`:
  ```
  credentials.json
  token.json
  ```

## Usage

### Basic Usage

Create Gmail drafts for all entries:
```bash
python main.py
```

### Dry Run (Recommended First Step)

Preview what would be created without calling Gmail API:
```bash
python main.py --dry-run
```

### Command-Line Options

```bash
python main.py [OPTIONS]
```

#### Options

- `--input FILE` - Input Excel file path (default: `output/output34.xlsx`)
- `--output FILE` - Output report file (optional)
- `--dry-run` - Show what would be created without API calls
- `--verbose` - Enable debug-level logging
- `--limit N` - Process only first N entries
- `--delay SECONDS` - Delay between API calls (default: 0.5)
- `--help` - Show help message

### Examples

```bash
# Dry run to see what would happen
python main.py --dry-run

# Create drafts for first 5 entries
python main.py --limit 5

# Verbose output for debugging
python main.py --verbose

# Custom input file
python main.py --input /path/to/custom_file.xlsx

# Slower API calls (respect rate limits)
python main.py --delay 2.0
```

## Input File Format

Agent4 expects `output/output34.xlsx` with the following columns:

| Column | Required | Description | Example |
|--------|----------|-------------|---------|
| `email` | Yes | Student email address | `alice@example.com` |
| `name` | Yes | Student name | `Alice Johnson` |
| `Repo URL` | Yes | GitHub repository URL | `https://github.com/user/E18_ml` |
| `greeting` | Yes | Personalized greeting message | `Fantastic work! ...` |
| `grade` | Yes | Code quality grade (0-100) | `85.50` |

### Example Input

| email | name | Repo URL | greeting | grade |
|-------|------|----------|----------|-------|
| alice@example.com | Alice Johnson | https://github.com/alice/E18_ml.git | Fantastic work! You're a winner! | 85.50 |
| bob@example.com | Bob Smith | https://github.com/bob/E19_web | Hey, keep it funky! Great effort! | 45.00 |

## Generated Email Template

### Subject Line
```
Code Review: E18_logistic_regression
```

### Email Content

```
Dear Alice,

Fantastic work! You're a winner, and these grades prove it. Tremendous execution!

Submission Details:
Repository: E18_logistic_regression
Grade: 85.50%
URL: https://github.com/alice/E18_logistic_regression.git

Best regards,
Code Review Team

This is an automated message from the Exercise Submission System
```

## Output

Agent4 creates Gmail **drafts** (not sent emails):

- **Location**: Gmail Drafts folder in authenticated user's account
- **Status**: Unfinished drafts (you can review and edit before sending)
- **Count**: One draft per valid entry
- **Format**: HTML with plain text fallback

### Checking Results

After running Agent4:

1. Open Gmail
2. Go to **Drafts** folder
3. Verify:
   - ✓ Correct recipient email addresses
   - ✓ Personalized greetings included
   - ✓ Repository URLs are clickable
   - ✓ Grades formatted correctly
   - ✓ Professional HTML formatting

## Logging

Agent4 provides detailed logging at multiple levels:

### Log Levels

- **INFO**: High-level progress (authentication, draft creation summary)
- **DEBUG**: Detailed operations (individual API calls, email composition)
- **WARNING**: Non-critical issues (invalid emails, skipped entries)
- **ERROR**: Processing failures (API errors, authentication failures)

### Example Log Output

```
==================================================
  Gmail Draft Creator - Agent4
==================================================
2024-01-15 10:30:00 - __main__ - INFO - Starting Gmail draft creation workflow
2024-01-15 10:30:00 - __main__ - INFO - Input file: output/output34.xlsx
2024-01-15 10:30:00 - __main__ - INFO - Reading input file: output/output34.xlsx
2024-01-15 10:30:00 - excel_reader - INFO - Read 4 data rows from output/output34.xlsx
2024-01-15 10:30:00 - __main__ - INFO - Validating entries...
2024-01-15 10:30:00 - __main__ - INFO - Validation complete: 4 valid, 0 invalid
2024-01-15 10:30:00 - __main__ - INFO - Authenticating with Gmail API...
2024-01-15 10:30:00 - gmail_client - INFO - Gmail authentication initialized
2024-01-15 10:30:00 - __main__ - INFO - Successfully authenticated with Gmail API
2024-01-15 10:30:00 - __main__ - INFO - Creating Gmail drafts for 4 entries...
2024-01-15 10:30:00 - gmail_client - INFO - Draft created for alice@example.com
2024-01-15 10:30:00 - gmail_client - INFO - Draft created for bob@example.com
2024-01-15 10:30:00 - gmail_client - INFO - Draft created for charlie@example.com
2024-01-15 10:30:00 - gmail_client - INFO - Draft created for david@example.com
==================================================
COMPLETION SUMMARY
==================================================
Status: ✓ SUCCESS
Mode: PRODUCTION

Processing Statistics:
  Total entries read: 4
  Valid entries: 4
  Invalid entries: 0

Draft Creation:
  Drafts created: 4
  Drafts failed: 0
  Success rate: 100.0%
==================================================
```

### Enable Verbose Logging

```bash
python main.py --verbose
```

This sets logging to DEBUG level, showing all operations in detail.

## Testing

Run the test suite:

```bash
# Run all tests
pytest

# Run with coverage
pytest --cov=agent4

# Run specific test file
pytest test_email_composer.py

# Run specific test
pytest test_email_composer.py::TestGenerateSubject::test_generate_subject_basic

# Verbose output
pytest -v

# Show print statements
pytest -s
```

### Test Organization

- **test_email_composer.py**: Email composition and formatting
- **test_excel_reader.py**: Excel reading and validation
- **test_gmail_client.py**: Gmail API integration and draft creation
- **test_main.py**: Integration tests and workflow

### Expected Test Results

All 43 tests should pass:

```
test_email_composer.py ..................... [10 tests]
test_excel_reader.py ....................... [12 tests]
test_gmail_client.py ........................ [16 tests]
test_main.py ............................... [5 tests]

Total: 43 tests passed
```

## Error Handling

### Common Issues and Solutions

| Issue | Cause | Solution |
|-------|-------|----------|
| `FileNotFoundError: Input file not found` | Agent3 hasn't run | Run Agent3 first to generate output34.xlsx |
| `Invalid email format` | Malformed email in entry | Check email addresses in output34.xlsx |
| `Invalid repository URL` | Malformed or non-GitHub URL | Ensure URLs start with https://github.com |
| Gmail API error (401) | Token expired | Delete token.json and re-authenticate |
| Gmail API error (403) | Insufficient permissions | Check OAuth2 scopes in credentials |
| Gmail API error (429) | Rate limited | Use --delay option to slow down API calls |

### Troubleshooting

**1. Gmail authentication fails:**
```bash
# Delete cached token and re-authenticate
rm token.json
python main.py --dry-run
```

**2. Some entries fail but others succeed:**
- Use dry-run mode to identify problematic entries:
```bash
python main.py --dry-run --verbose
```
- Check the invalid entries list in the completion summary
- Fix the data in output34.xlsx and re-run

**3. Gmail API quota exceeded:**
- Gmail has a daily quota (1000 requests/user/day)
- Use --delay option to slow down:
```bash
python main.py --delay 5.0
```
- Or split into multiple runs on different days

**4. Check logs for detailed error messages:**
```bash
python main.py --verbose 2>&1 | grep ERROR
```

## Project Structure

```
agent4/
├── __init__.py                 # Package initialization
├── main.py                     # CLI entry point
├── email_composer.py           # Email composition
├── excel_reader.py             # Excel reading and validation
├── gmail_client.py             # Gmail API integration
├── test_*.py                   # Test suite (43 tests)
├── pyproject.toml              # Dependencies and project metadata
├── README.md                   # This file
├── PLAN.md                     # Implementation specification
├── credentials.json            # OAuth2 credentials (gitignore)
└── token.json                  # OAuth2 token (gitignore)
```

## Pipeline Integration

Agent4 is the final step in the exercise submission pipeline:

1. **Agent1**: Extract Gmail exercises → `output12.xlsx`
   - Reads exercise submissions from Gmail

2. **Agent2**: Analyze repositories → `output23.xlsx`
   - Analyzes code quality, generates grades

3. **Agent3**: Add greetings → `output34.xlsx`
   - Adds personalized greetings based on grades

4. **Agent4**: Create Gmail drafts → **Gmail Drafts** ✓
   - Creates draft emails for manual review and sending

## Technical Details

### Modules

#### **email_composer.py**
Generates professional email content from entry data.

Key classes:
- `EmailComposer`: Static methods for email generation
  - `compose_email(entry)`: Complete email generation
  - `generate_subject(name, repo_url)`: Subject line
  - `generate_html_body(entry)`: HTML email
  - `generate_text_body(entry)`: Plain text email

#### **excel_reader.py**
Reads and validates Excel input data.

Key classes:
- `ExcelReader`: Static methods for Excel operations
  - `read_input_file(file_path)`: Read and parse Excel
  - `validate_email(email)`: Validate email format
  - `validate_url(url)`: Validate repository URL
  - `validate_entries(rows_data)`: Separate valid/invalid

#### **gmail_client.py**
Integrates with Gmail API for draft creation.

Key classes:
- `GmailAuthenticator`: OAuth2 authentication
  - `authenticate()`: Establish connection
  - `is_authenticated()`: Check status

- `GmailDraftCreator`: Create email drafts
  - `create_draft(...)`: Create single draft
  - `create_drafts_batch(...)`: Batch creation
  - `get_statistics()`: Processing stats

#### **main.py**
Orchestrates the complete workflow.

Key functions:
- `run_workflow()`: Main processing logic
- `parse_arguments()`: CLI argument parsing
- `main()`: Entry point

### Dependencies

- **openpyxl**: Excel file reading/writing
- **google-auth**: OAuth2 authentication
- **google-api-python-client**: Gmail API client
- **google-auth-oauthlib**: OAuth2 flow for user authentication
- **google-auth-httplib2**: HTTP transport for Gmail API

## Performance

- **Processing Speed**: 1-2 seconds per draft (including API delay)
- **API Calls**: One per entry
- **Batch Examples**:
  - 4 entries: ~6-8 seconds
  - 10 entries: ~15-20 seconds
  - 50 entries: ~1.5-2.5 minutes
  - 100 entries: ~3-5 minutes

## Best Practices

1. **Always start with dry-run:**
   ```bash
   python main.py --dry-run
   ```

2. **Review output before sending:**
   - Check Gmail Drafts folder
   - Edit any necessary content
   - Verify formatting and links

3. **Handle errors gracefully:**
   - Fix invalid entries in output34.xlsx
   - Re-run Agent4 for corrections
   - Investigate errors in verbose mode

4. **Respect API limits:**
   - Use `--delay` option for large batches
   - Monitor Gmail API quota
   - Split large jobs into multiple runs if needed

5. **Keep credentials secure:**
   - Never commit credentials.json
   - Use .gitignore to exclude credential files
   - Rotate credentials periodically

## Future Enhancements

- [ ] Send emails directly instead of creating drafts
- [ ] Custom email templates per personality style
- [ ] Attachment support (e.g., detailed grade reports)
- [ ] Scheduled sending at specific times
- [ ] Reply templates for common questions
- [ ] Email tracking and analytics
- [ ] Webhook integration with external systems
- [ ] Multiple input file support
- [ ] SMS notification fallback

## Contributing

To contribute to Agent4:

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests for new functionality
5. Run the test suite: `pytest`
6. Submit a pull request

## Support

For issues or questions:

1. Check the [troubleshooting section](#troubleshooting)
2. Review the [PLAN.md](PLAN.md) for detailed technical specifications
3. Enable verbose logging: `python main.py --verbose`
4. Report issues: https://github.com/anthropics/claude-code/issues

## License

MIT License - See LICENSE file for details

## Version History

### v0.1.0 (Current)
- Initial release
- Gmail draft creation from Excel input
- Email validation and URL validation
- Professional HTML and text email templates
- Batch processing with error handling
- Comprehensive test suite (43 tests)
- OAuth2 authentication support
- Dry-run mode for preview

---

**Last Updated**: January 2024
**Maintainer**: Claude Code
